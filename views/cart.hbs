<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Your Cart</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
</head>

<body>
    <h1>Your Cart</h1>
    <table id="cart-table">
        <thead>
            <tr>
                <th>Product Name</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total Price</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {{#each cart}}
            <tr>
                <td>{{name}}</td>
                <td>${{price}}</td>
                <td>
                    <input type="number" min="1" value="{{quantity}}" class="quantity-input" data-item-id="{{id}}" data-price="{{price}}">
                </td>
                <td class="item-total-price">${{totalPrice}}</td>
                <td>
                    <button class="remove-btn" data-item-id="{{id}}">Remove</button>
                </td>
            </tr>
            {{/each}}
        </tbody>
        <tr>
            <td colspan="3">Grand Total:</td>
            <td id="grand-total">${{grandTotal}}</td>
            <td></td>
        </tr>
    </table>

    <button id="checkout-button" style="display: none;">Checkout</button>
    <a href="/products">Back to Products</a>

    <script>
        $(document).ready(function() {
            function calculateItemTotalPrice() {
                $('.quantity-input').each(function() {
                    const price = parseFloat($(this).data('price'));
                    const quantity = parseInt($(this).val());
                    const totalPrice = price * quantity;
                    $(this).closest('tr').find('.item-total-price').text(`$${totalPrice.toFixed(2)}`);
                });
            }

            function updateTotals() {
                $.ajax({
                    url: '/cart/get-totals',
                    method: 'GET',
                    success: function(response) {
                        for (const item of response.items) {
                            const itemRow = $(`tr[data-item-id='${item.id}']`);
                            itemRow.find('.item-total-price').text(`$${item.totalPrice.toFixed(2)}`);
                        }
                        $('#grand-total').text(`$${response.grandTotal.toFixed(2)}`);
                        toggleCheckoutButtonVisibility();
                    },
                    error: function(error) {
                        console.error('Error fetching totals:', error);
                    }
                });
            }

            function isCartEmpty() {
                return $('.quantity-input').length === 0;
            }

            function toggleCheckoutButtonVisibility() {
                if (isCartEmpty()) {
                    $('#checkout-button').hide();
                } else {
                    $('#checkout-button').show();
                }
            }

            updateTotals();
            calculateItemTotalPrice();
            $('#cart-table').DataTable();

            $('.quantity-input').on('change', function() {
                const itemId = $(this).data('item-id');
                const newQuantity = $(this).val();
                const price = $(this).data('price');
                const newItemTotalPrice = newQuantity * price;
                $(this).closest('tr').find('.item-total-price').text(`$${newItemTotalPrice.toFixed(2)}`);
                $.ajax({
                    url: '/cart/update',
                    method: 'POST',
                    data: {
                        itemId: itemId,
                        quantity: newQuantity
                    },
                    success: function(response) {
                        $('#grand-total').text(`$${response.grandTotal.toFixed(2)}`);
                        toggleCheckoutButtonVisibility();
                    },
                    error: function(error) {
                        console.error('Error updating cart:', error);
                    }
                });
            });

            $('.remove-btn').on('click', function() {
                const itemId = $(this).data('item-id');
                $.ajax({
                    url: '/cart/remove',
                    method: 'POST',
                    data: {
                        itemId: itemId
                    },
                    success: function(response) {
                        location.reload();
                        toggleCheckoutButtonVisibility();
                    },
                    error: function(error) {
                        console.error('Error removing item from cart:', error);
                    }
                });
            });

            $('#checkout-button').on('click', function() {
                window.location.href = '/order';
            });
        });
    </script>
</body>

</html>
